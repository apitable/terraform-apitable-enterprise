apiVersion: v1
kind: ConfigMap
metadata:
  name: openresty-config
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook-weight": "-1"
data:
  backend-server.conf: |
    location /api {
      proxy_pass   http://backend;
      proxy_set_header X-Real-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Real-PORT $remote_port;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Original-URI $request_uri;
      proxy_set_header Access-Control-Allow-Headers 'Cookie,Set-Cookie,x-requested-with,content-type';
      proxy_set_header Access-Control-Allow-Origin $http_origin;
      proxy_set_header 'Access-Control-Allow-Credentials' 'true';
      add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,OPTIONS';

      proxy_connect_timeout 180s;
      proxy_read_timeout 180s;
      proxy_send_timeout 180s;
    }

    location /api/v1/node/readShareInfo {
      proxy_pass   http://backend;
      proxy_set_header X-Real-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Real-PORT $remote_port;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Original-URI $request_uri;
      proxy_set_header Origin "";
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PATCH' always;
      add_header 'Access-Control-Allow-Headers' 'Cookie ,Origin, X-Requested-With,Content-Type, Accept' always;
      if ($request_method = 'OPTIONS' ) {
         return 204;
      }
      proxy_connect_timeout 180s;
      proxy_read_timeout 180s;
      proxy_send_timeout 180s;
    }  

    {{- if .Values.app.ai_server.enabled }}
    location /api/v1/ai {
      proxy_pass   http://backend;
      proxy_set_header X-Real-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Real-PORT $remote_port;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Original-URI $request_uri;
      proxy_set_header Access-Control-Allow-Headers 'Cookie,Set-Cookie,x-requested-with,content-type';
      proxy_set_header Access-Control-Allow-Origin $http_origin;
      proxy_set_header 'Access-Control-Allow-Credentials' 'true';
      proxy_buffering off;
      add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,OPTIONS';

      proxy_connect_timeout 180s;
      proxy_read_timeout 180s;
      proxy_send_timeout 180s;
    }
    {{- end }}

  nginx.conf: |
    worker_processes {{ .Values.app.openresty.worker_processes }};
    pcre_jit on;

    events {
        worker_connections 204800;
        multi_accept on;
    }
    http {
        include       mime.types;
        default_type  application/octet-stream;
        log_format json_combined escape=json '{"@timestamp":"$time_iso8601",'
                  '"@source":"$server_addr",'
                  '"@nginx_fields":{'
                  '"remote_addr":"$remote_addr",'
                  '"body_bytes_sent":"$body_bytes_sent",'
                  '"request_time":"$request_time",'
                  '"status":"$status",'
                  '"host":"$host",'
                  '"uri":"$uri",'
                  '"server":"$server_name",'
                  '"request_uri":"$request_uri",'
                  '"request_method":"$request_method",'
                  '"http_referrer":"$http_referer",'
                  '"http_x_forwarded_for":"$http_x_forwarded_for",'
                  '"http_user_agent":"$http_user_agent",'
                  '"upstream_response_time":"$upstream_response_time",'
                  '"upstream_status":"$upstream_status",'
                  '"upstream_addr":"$upstream_addr"}}';

        access_log  /dev/stdout json_combined;
        server_tokens off;

        lua_shared_dict gray 64m;

        client_max_body_size  1024m;

        proxy_buffer_size 16k;
        proxy_buffers 4 64k;
        proxy_busy_buffers_size 128k;
        proxy_cache_path /tmp/cache levels=1:2 keys_zone=cache_one:200m inactive=1d max_size=3g;

        gzip on;
        gzip_proxied any;
        gzip_comp_level 5;
        gzip_buffers 16 8k;
        gzip_min_length 1024;
        gzip_http_version 1.1;
        gzip_types text/plain application/x-javascript text/css text/javascript application/json application/javascript;

        include /etc/nginx/conf.d/upstream/*.conf;
        map $http_upgrade $connection_upgrade {
            default upgrade;
            ''      close;
        }

        server {
              listen 80 default;
              server_name  127.0.0.1;
              charset utf-8;
              error_page 404 502 503   /404;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Real-PORT $remote_port;
              proxy_set_header X-Original-URI $request_uri;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

              include /etc/nginx/conf.d/server/*.conf;

              location =/healthz {
                return 200;
                access_log off;
              }

              location =/robots.txt {
                root /usr/local/openresty/nginx/html;
              }

              {{ .Values.openresty_server_block }}
        }

        include /etc/nginx/conf.d/vhost/*.conf;
    }

  ssl-default.conf: ""

  ssl-host.conf: |
    server {
          listen 443 ssl http2;
          server_name  {{ .Values.server_name }};

          ssl_certificate     /etc/nginx/conf.d/certs/tls.crt;
          ssl_certificate_key /etc/nginx/conf.d/certs/tls.key;
          ssl_session_timeout 1d;
          ssl_session_cache shared:MozSSL:10m;
          ssl_session_tickets off;

          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384;
          ssl_prefer_server_ciphers off;

          charset utf-8;

          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Real-PORT $remote_port;
          proxy_set_header X-Original-URI $request_uri;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

          include /etc/nginx/conf.d/server/*.conf;

          {{ .Values.openresty_server_block }}

          location =/healthz {
            return 200;
            access_log off;
          }

          location =/robots.txt {
            root /usr/local/openresty/nginx/html;
          }
    }

  room-server.conf: |
    location ~* ^/(actuator|nest) {
      proxy_pass   http://nest-rest;

      proxy_set_header X-Real-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Real-PORT $remote_port;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Original-URI $request_uri;

      proxy_connect_timeout 180s;
      proxy_read_timeout 180s;
      proxy_send_timeout 180s;
    }

    location /document {
      proxy_pass   http://document;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header X-Nginx-Proxy true;
      proxy_set_header Host $host:$server_port;
      proxy_http_version 1.1;
      proxy_connect_timeout 300s;
      proxy_read_timeout 300s;
      proxy_send_timeout 300s;
    }

    {{- if .Values.app.ai_server.enabled }}
    location ^~ /nest/v1/ai {
      proxy_pass http://nest-rest;

      chunked_transfer_encoding off;
      proxy_buffering off;
      proxy_cache off;
      proxy_http_version 1.1;
      proxy_set_header Connection '';

      proxy_set_header X-Real-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Real-PORT $remote_port;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Original-URI $request_uri;

      proxy_connect_timeout 180s;
      proxy_read_timeout 180s;
      proxy_send_timeout 180s;
    }
    {{- end }}

  fusion-server.conf: |
    location /fusion {
      proxy_pass   http://fusion;
      proxy_next_upstream error http_502 non_idempotent;
      proxy_next_upstream_tries 3;
      error_page 404 503 /404;

      proxy_set_header X-Real-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Real-PORT $remote_port;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Original-URI $request_uri;
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PATCH' always;
      add_header 'Access-Control-Allow-Headers' 'Authorization,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Range,Range,x-vika-user-agent' always;
      if ($request_method = 'OPTIONS' ) {
         return 204;
      }
      proxy_connect_timeout 180s;
      proxy_read_timeout 180s;
      proxy_send_timeout 180s;
    }

  socket-server.conf: |
    location /room {
      proxy_pass   http://socketRoom;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header X-Nginx-Proxy true;
      proxy_set_header Host $host:$server_port;
      proxy_http_version 1.1;
      proxy_connect_timeout 300s;
      proxy_read_timeout 300s;
      proxy_send_timeout 300s;
    }

    location /notification {
      proxy_pass   http://socket;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header X-Nginx-Proxy true;
      proxy_set_header Host $host:$server_port;
      proxy_http_version 1.1;
      proxy_connect_timeout 300s;
      proxy_read_timeout 300s;
      proxy_send_timeout 300s;
    }

  ai-server.conf: |
    {{- if .Values.app.ai_server.enabled }}
    # location /ai {
    #   proxy_pass   http://ai-server;
    #   proxy_set_header X-Real-Host $http_host;
    #   proxy_set_header X-Real-IP $remote_addr;
    #   proxy_set_header X-Real-PORT $remote_port;
    #   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #   proxy_set_header X-Original-URI $request_uri;
    #   proxy_set_header Access-Control-Allow-Headers 'Cookie,Set-Cookie,x-requested-with,content-type';
    #   proxy_set_header Access-Control-Allow-Origin $http_origin;
    #   proxy_set_header 'Access-Control-Allow-Credentials' 'true';
    #   proxy_buffering off;
    #   add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,OPTIONS';

    #   proxy_connect_timeout 180s;
    #   proxy_read_timeout 180s;
    #   proxy_send_timeout 180s;
    # }
    {{- end }}

  ups-ai-server.conf: |
    {{- if .Values.app.ai_server.enabled }}
    upstream ai-server {
       server ai-server:8626;
    }
    {{- end }}

  databus-server.conf: |
    {{- if .Values.app.databus_server.enabled }}
    location /fusion/v3 {
      proxy_pass   http://databus-server;

      proxy_set_header X-Real-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Real-PORT $remote_port;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Original-URI $request_uri;

      proxy_connect_timeout 180s;
      proxy_read_timeout 180s;
      proxy_send_timeout 180s;
    }
    {{- end }}

  ups-databus-server.conf: |
    {{- if .Values.app.databus_server.enabled }}
    upstream databus-server {
       server databus-server:8625;
    }
    {{- end }}

  job-admin-server.conf: |
    {{- if .Values.app.job_admin_server.enabled }}
    location /job-admin {
      proxy_pass   http://job-admin-server;
    }
    {{- end }}

  ups-job-admin-server.conf: |
    {{- if .Values.app.job_admin_server.enabled }}
    upstream job-admin-server  {
       server {{ .Values.job_admin_server_host }}:8080;
    }
    {{- end }}

  ups-backend-server.conf: |
    upstream backend  {
       server backend-server:8081;
    }

  ups-room-server.conf: |
    upstream room  {
       server room-server:3333;
    }
    upstream nest-rest  {
       server nest-rest-server:3333;
    }
    upstream document  {
       server document-server:3006;
    }

  ups-fusion-server.conf: |
    upstream fusion  {
       server fusion-server:3333 max_fails=0;
       server fusion-server:3333 max_fails=0;
       server fusion-server:3333 max_fails=0;
    }

  ups-socket-server.conf: |
    upstream socket  {
       server socket-server:3002;
    }
    upstream socketRoom  {
       server socket-server:3005;
    }

  ups-web-server.conf: |
    upstream web-server {
       server web-server:8080;
    }

  web-server.conf: |
    location / {
       proxy_set_header X-Nginx-Proxy true;
       proxy_set_header Host {{ if .Values.default_server_host_override_proxy_host }}{{ .Values.default_server_host_override_proxy_host }}{{ else }}$http_host{{ end }};
       proxy_set_header X-Original-URI $request_uri;
       proxy_http_version 1.1;
       proxy_pass {{ .Values.default_server_host }};

       {{ .Values.openresty_index_block }}
    }

    location =/wp-admin/admin-ajax.php {
        proxy_pass {{ .Values.default_server_host }};
        proxy_set_header Host {{ if .Values.default_server_host_override_proxy_host }}{{ .Values.default_server_host_override_proxy_host }}{{ else }}$http_host{{ end }};
        proxy_set_header X-Original-URI $request_uri;
    }

    location  ~* ^/(wp-admin|wp-login.php|readme.html|xmlrpc.php){
        deny all;
    }

    location =/ {
      proxy_set_header Host {{ if .Values.default_server_host_override_proxy_host }}{{ .Values.default_server_host_override_proxy_host }}{{ else }}$http_host{{ end }};
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_cache off;
      set $cms 0;
      {{ .Values.openresty_index_block }}

      if ($uri ~* wp-login.php$){
           proxy_pass {{ .Values.default_server_host }};
           set $cms 1;
      }
      if ($args ~* home=1){
           proxy_pass {{ .Values.default_server_host }};
           set $cms 1;
      }

      if ($http_referer ~* "wp-admin"){
           proxy_pass {{ .Values.default_server_host }};
           set $cms 1;
      }

      if ($http_user_agent ~* "qihoobot|Baiduspider|Googlebot|Googlebot-Mobile|Googlebot-Image|Mediapartners-Google|Adsbot-Google|Feedfetjauntycher-Google|Yahoo! Slurp|Yahoo! Slurp China|YoudaoBot|Sosospider|Sogouspider|Sogou web spider|MSNBot|ia_archiver|Tomato Bot"){
           proxy_pass {{ .Values.default_server_host }};
           set $cms 1;
      }

      if ($cms = 0){
          {{- if .Values.default_server_host_override_proxy_host }}
           proxy_pass ${var.default_server_host};
           {{else}}
           proxy_pass   http://web-server;
           add_header  Content-Type    text/html;
           add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
           expires off;
          {{- end }}
        }
    }
      #Allow embedded routes
    location ~* ^/(login|share|404|widget-stage|embed) {
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 300;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      chunked_transfer_encoding off;
      proxy_pass   http://web-server;
      add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    }

    #Allow embedded routes and cache
    location ~* ^/(custom|file)/ {
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 300;
      proxy_pass   http://web-server;
      add_header 'Cache-Control' 'public, max-age=2592000';
      proxy_redirect off;
      proxy_cache cache_one;
      proxy_cache_valid 200 302 1h;
      proxy_cache_valid 301 1d;
      proxy_cache_valid any 1m;
      expires 7d;
    }

    #Prevent external sites from embedding routes
    location ~* ^/(space|user|invite|template|workbench|org|management|notify) {
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 300;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      chunked_transfer_encoding off;
      proxy_pass   http://web-server;
      add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
      add_header 'X-Frame-Options' 'SAMEORIGIN';
    }

    location /_next {
        proxy_pass   http://web-server;
        proxy_connect_timeout 300;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Static resources (config_map_kong will overwrite this in saas environment)
    location /web_build {
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://web-server/web_build;
      add_header 'Cache-Control' 'public, max-age=2592000';
      proxy_redirect off;
      proxy_cache cache_one;
      proxy_cache_valid 200 302 1h;
      proxy_cache_valid 301 1d;
      proxy_cache_valid any 1m;
      expires 7d;
    }
  lbs-amap.conf: |
    {{- if .Values.lbs_amap_secret }}
    location /_AMapService/v4/map/styles {
        set $args "$args&jscode={{ .Values.lbs_amap_secret }}";
        proxy_pass https://webapi.amap.com/v4/map/styles;
    }

    location /_AMapService/v3/vectormap {
        set $args "$args&jscode={{ .Values.lbs_amap_secret }}";
        proxy_pass https://fmap01.amap.com/v3/vectormap;
    }

    location /_AMapService/ {
        set $args "$args&jscode={{ .Values.lbs_amap_secret }}";
        proxy_pass https://restapi.amap.com/;
    }
    {{- end }}
  
  robots.txt: | 
    {{-  if .Values.app.openresty.disallowRobots }}
    User-agent: *
    Disallow: /
    {{ else }}
    User-agent: *
    Disallow: /wp-admin/
    Allow: /wp-admin/admin-ajax.php
    {{- end }}

  static-proxy.conf: |
    {{- if .Values.developers_redirect_url }}
    location ^~ /developers {
        rewrite ^/developers/?(.*)$ {{ .Values.developers_redirect_url }}/$1 permanent;
    }
    {{- end }}
    location /pricing {
        proxy_pass   {{ .Values.pricing_host }};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /pricing/_next {
        proxy_pass   {{ .Values.pricing_host }}/_next;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header 'Cache-Control' 'public, max-age=2592000';
        proxy_redirect off;
        proxy_cache cache_one;
        proxy_cache_valid 200 302 1h;
        proxy_cache_valid 301 1d;
        proxy_cache_valid any 1m;
        expires 7d;
    }

  imageproxy-server.conf: |
    {{- if .Values.app.imageproxy_server.enabled }}
    location /{{ default "assets" .Values.global.env.ASSETS_BUCKET }} {
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_cache cache_one;
      proxy_cache_valid 200 302 3h;
      proxy_cache_valid any 1m;

      proxy_connect_timeout 300;
      chunked_transfer_encoding off;
      proxy_pass   http://imageproxy-server/image/{{ default "assets" .Values.global.env.ASSETS_BUCKET }}/;
      if ( $args !~* ^imageView ){
          proxy_pass   {{ .Values.minio_host }};
      }

      if ( $request_method = PUT ){
         proxy_pass {{ .Values.minio_host }};
      }
    }

    location ~* ^/(minio) {
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 300;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      chunked_transfer_encoding off;
      proxy_pass   {{ .Values.minio_host }};
    }

    location /oss {
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 300;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      chunked_transfer_encoding off;
      proxy_pass {{ .Values.minio_host }}/{{ default "assets" .Values.global.env.ASSETS_BUCKET }}/;
    }

    location =/{{ default "assets" .Values.global.env.ASSETS_BUCKET }} {
       return 403;
    }

    location =/{{ default "assets" .Values.global.env.ASSETS_BUCKET }}/ {
       return 403;
    }
  {{ else }}
   # no imageproxy-server
  {{- end }}

  blank.config: |

  openresty_extra_config.conf: |
    {{ .Values.app.openresty.openresty_extra_config }}
